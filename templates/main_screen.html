<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comunication_LTD - System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }

        /* Styles for the modal overlay */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        /* NEW STYLE FROM REFERENCE: Bottom border inputs */
        .form-input {
            background-color: transparent;
            border: 0;
            border-bottom: 1px solid #4b5563;
            width: 100%;
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            color: #DCDFF0;
            transition: border-color 0.2s ease-in-out;
        }
        .form-input:focus {
            outline: none;
            border-bottom-color: #AD8BE9;
        }
    </style>
</head>
<body class="bg-[#111827] text-gray-300 min-h-screen relative">

<nav class="bg-gray-900 border-b border-[#AD8BE9]">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
            <div class="flex items-center">
                <span class="text-xl font-semibold text-[#DCDFF0]">Comunication_LTD</span>
            </div>
            <div class="flex items-center gap-4">
                <span class="text-gray-400">Hello, <span class="text-white font-bold" style="color: #DCDFF0">{{ user.username }}</span></span>
                <form action="{% url 'logout' %}" method="post">
                    {% csrf_token %}
                    <button type="submit" class="text-sm text-red-400 hover:text-red-300 transition-colors">
                        Logout
                    </button>
                </form>
            </div>
        </div>
    </div>
</nav>

{% if messages %}
<div class="max-w-4xl mx-auto mt-6 px-4">
    {% for message in messages %}
    <div class="{% if message.tags == 'error' %}bg-red-900 text-red-100 border-red-700{% else %}bg-green-900 text-green-100 border-green-700{% endif %} border p-4 rounded-lg shadow-md mb-4">
        {{ message }}
    </div>
    {% endfor %}
</div>
{% endif %}

<div class="max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
    <div class="text-center mb-12">
        <h1 class="text-3xl font-light text-white mb-2" style="color: #DCDFF0">Welcome to the Dashboard</h1>
        <p class="text-gray-500">Select an action below</p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl mx-auto">
        <div class="bg-gray-800 p-8 rounded-xl border border-gray-700 hover:border-[#AD8BE9] transition-colors group">
            <div class="mb-4"><span class="text-2xl">ðŸ”’</span></div>
            <h3 class="text-xl font-medium text-white mb-2" style="color: #DCDFF0">Change Password</h3>
            <p class="text-gray-400 mb-6">Update your account security credentials.</p>
            <button onclick="openModal()"
                    class="w-full py-3 px-4 bg-[#AD8BE9] hover:bg-[#7660A0] text-white rounded-lg transition-colors font-medium">
                Change Password
            </button>
        </div>

        <div class="bg-gray-800 p-8 rounded-xl border border-gray-700 hover:border-green-500 transition-colors group">
            <div class="mb-4"><span class="text-2xl">ðŸ‘¤</span></div>
            <h3 class="text-xl font-medium text-white mb-2" style="color: #DCDFF0">Add New Customer</h3>
            <p class="text-gray-400 mb-6">Register a new customer to the database.</p>
            <button class="w-full py-3 px-4 bg-gray-700 text-gray-300 rounded-lg cursor-not-allowed opacity-70"
                    disabled>
                Add Customer (Coming Soon)
            </button>
        </div>
    </div>
</div>

<div id="passwordModal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog"
     aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">

        <div class="fixed inset-0 modal-overlay transition-opacity" aria-hidden="true" onclick="closeModal()"></div>

        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-[#111827] rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full border border-gray-700 p-6">

            <form action="{% url 'change_password' %}" method="POST">
                {% csrf_token %}

                <h3 class="text-3xl font-light mb-2 text-[#DCDFF0]" id="modal-title">Change Password</h3>
                <p class="text-gray-400 mb-8 text-sm">Update your current password securely.</p>

                <div class="space-y-6">
                    <div>
                        <label for="old_password" class="block text-sm font-light text-gray-400">Current
                            Password</label>
                        <input type="password" name="old_password" id="old_password" required class="form-input">
                    </div>

                    <div>
                        <label for="new_password" class="block text-sm font-light text-gray-400">New Password</label>
                        <input type="password" name="new_password" id="new_password" required class="form-input">
                    </div>
                    <div id="password-criteria" class="mb-8">
                        <ul id="password-rules" class="text-sm space-y-1 mt-6 mb-6">
                            {% if password_rules.length > 0 %}
                            <li id="rule-length"
                                data-text="At least {{ password_rules.length }} characters"
                                class="flex items-center text-red-400">
                                âœ– At least {{ password_rules.length }} characters
                            </li>
                            {% endif %}

                            {% if password_rules.uppercase %}
                            <li id="rule-upper"
                                data-text="Contains an uppercase letter"
                                class="flex items-center text-red-400">
                                âœ– Contains an uppercase letter
                            </li>
                            {% endif %}

                            {% if password_rules.lowercase %}
                            <li id="rule-lower"
                                data-text="Contains a lowercase letter"
                                class="flex items-center text-red-400">
                                âœ– Contains a lowercase letter
                            </li>
                            {% endif %}

                            {% if password_rules.digit %}
                            <li id="rule-digit"
                                data-text="Contains a number"
                                class="flex items-center text-red-400">
                                âœ– Contains a number
                            </li>
                            {% endif %}

                            {% if password_rules.special %}
                            <li id="rule-special"
                                data-text="Contains a special character"
                                class="flex items-center text-red-400">
                                âœ– Contains a special character
                            </li>
                            {% endif %}
                        </ul>
                    </div>
                    <div>
                        <label for="confirm_password" class="block text-sm font-light text-gray-400">Confirm
                            Password</label>
                        <input type="password" name="confirm_password" id="confirm_password" required
                               class="form-input">
                    </div>

                </div>

                <div class="mt-8 flex flex-col sm:flex-row-reverse gap-3">
                    <button id="save-password-btn" type="submit"
                            class="w-full sm:w-auto py-2.5 px-4 bg-[#AD8BE9] hover:bg-[#7660A0] text-white rounded-lg transition-colors font-medium opacity-50 cursor-not-allowed"
                            disabled>
                        Update Password
                    </button>
                    <button type="button" onclick="closeModal()"
                            class="w-full sm:w-auto py-2.5 px-4 bg-transparent border border-gray-600 text-gray-300 hover:text-white hover:border-gray-400 rounded-lg transition-colors font-medium">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // --- Modal Logic ---
    const modal = document.getElementById('passwordModal');
    const saveBtn = document.getElementById('save-password-btn');
    const oldPwd = document.getElementById('old_password');
    const newPwd = document.getElementById('new_password');
    const confirmPwd = document.getElementById('confirm_password');

    function openModal() {
        modal.classList.remove('hidden');
        validate(); // Run validation immediately on open
    }

    function closeModal() {
        modal.classList.add('hidden');
        oldPwd.value = '';
        newPwd.value = '';
        confirmPwd.value = '';
        // Reset validation visuals
        validate();
    }

    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') closeModal();
    });

    // --- Validation Logic (Adapted from Reference) ---
    document.addEventListener('DOMContentLoaded', () => {
        // We use Django variables here to ensure logic matches backend
        const rules = {
            length: {{ password_rules.length|default:"0" }},
            uppercase: {{ password_rules.uppercase|yesno:"true,false" }},
            lowercase: {{ password_rules.lowercase|yesno:"true,false" }},
            digit: {{ password_rules.digit|yesno:"true,false" }},
            special: {{ password_rules.special|yesno:"true,false" }}
        };

        function updateRule(id, isValid) {
            const el = document.getElementById(id);
            if (!el) return; // Guard clause in case a rule is disabled in Django

            const text = el.dataset.text;

            if (isValid) {
                el.classList.remove("text-red-400");
                el.classList.add("text-green-400");
                el.innerHTML = "âœ” " + text;
            } else {
                el.classList.remove("text-green-400");
                el.classList.add("text-red-400");
                el.innerHTML = "âœ– " + text;
            }
        }

        window.validate = function() {
            const value = newPwd.value;
            const confirmValue = confirmPwd.value;
            const oldValue = oldPwd.value;

            // Check individual rules
            const lengthOK  = rules.length === 0 || value.length >= rules.length;
            const upperOK   = !rules.uppercase || /[A-Z]/.test(value);
            const lowerOK   = !rules.lowercase || /[a-z]/.test(value);
            const digitOK   = !rules.digit || /\d/.test(value);
            const specialOK = !rules.special || /[^A-Za-z0-9]/.test(value);
            const matchOK   = value === confirmValue && value.length > 0;

            // Update UI
            if(rules.length > 0) updateRule("rule-length", lengthOK && value.length > 0);
            if(rules.uppercase) updateRule("rule-upper", upperOK && value.length > 0);
            if(rules.lowercase) updateRule("rule-lower", lowerOK && value.length > 0);
            if(rules.digit) updateRule("rule-digit", digitOK && value.length > 0);
            if(rules.special) updateRule("rule-special", specialOK && value.length > 0);

            // Button State
            // Ensure all rules are met AND old password is not empty
            const allGood =
                lengthOK && upperOK && lowerOK && digitOK && specialOK &&
                matchOK &&
                oldValue.trim() !== "";

            saveBtn.disabled = !allGood;
            saveBtn.classList.toggle("opacity-50", !allGood);
            saveBtn.classList.toggle("cursor-not-allowed", !allGood);
        }

        newPwd.addEventListener('input', validate);
        confirmPwd.addEventListener('input', validate);
        oldPwd.addEventListener('input', validate);

        // Initial run
        validate();
    });
</script>

</body>
</html>